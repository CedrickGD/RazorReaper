@page "/server"
@using System.Net
@using System.Net.NetworkInformation
@using System.Net.Sockets
@using System.Text.Json
@using Microsoft.Win32
@using RazorReaper.Components.Shared
@inject IJSRuntime JSRuntime

<div class="app-container">
    <RazorReaper.Components.Shared.SharedNavbar />

    <main class="main-content">
        <header class="page-header">
            <h1 class="page-title">Server Management</h1>
            <p class="page-subtitle">Connect and manage ARK servers</p>
        </header>

        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem; height: calc(100vh - 200px);">

            <div style="display: flex; flex-direction: column; gap: 1.5rem;">

                <div class="content-card">
                    <h3 class="mb-3 text-white">Server Connection</h3>

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Server IP Address</label>
                            <input @bind="serverInput" @onkeypress="@(async (e) => { if (e.Key == "Enter") await QueryServer(); })"
                                   placeholder="141.98.157.224:27015"
                                   class="server-input" />
                        </div>

                        @if (!string.IsNullOrWhiteSpace(serverInput))
                        {
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">Steam Connect URL</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input value="@GetSteamUrl()" readonly class="server-input readonly" />
                                    <button class="btn btn-secondary" @onclick="CopySteamUrl" style="font-size: 0.8rem; padding: 0.5rem;">📋</button>
                                </div>
                            </div>
                        }

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <button class="btn btn-primary" @onclick="QueryServer" disabled="@isQuerying" style="font-size: 0.85rem;">
                                @(isQuerying ? "⏳" : "🔍") Query
                            </button>
                            <button class="btn btn-success" @onclick="SaveServer" disabled="@(currentServer == null)" style="font-size: 0.85rem;">
                                💾 Save
                            </button>
                            <button class="btn btn-success" @onclick="ConnectToServer" style="font-size: 0.85rem;">
                                🔗 Connect
                            </button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <button class="btn btn-secondary" @onclick="AddToFavorites" style="font-size: 0.85rem;">
                                ⭐ Add Fav
                            </button>
                            <button class="btn btn-secondary" @onclick="OpenSteamBrowser" style="font-size: 0.85rem;">
                                🎮 Browser
                            </button>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="mt-3 server-status-message @GetStatusClass()">
                            <div style="font-weight: 600; font-size: 0.85rem;">@statusMessage</div>
                        </div>
                    }
                </div>

                @if (showServerInfo && selectedServer != null)
                {
                    <div class="content-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: var(--text-primary);">@selectedServer.Name</h3>
                            <button @onclick="HideServerInfo" class="btn btn-secondary" style="font-size: 0.8rem;">✕</button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; font-size: 0.85rem;">
                            <div class="server-info-section">
                                <div class="server-info-item">
                                    <span class="info-label">Status:</span>
                                    <span class="info-value @(selectedServer.IsOnline ? "online" : "offline")">
                                        @(selectedServer.IsOnline ? "Online" : "Offline")
                                    </span>
                                </div>
                                <div class="server-info-item">
                                    <span class="info-label">IP:</span>
                                    <span class="info-value">@selectedServer.IpAddress:@selectedServer.Port</span>
                                </div>
                                <div class="server-info-item">
                                    <span class="info-label">Players:</span>
                                    <span class="info-value online">@selectedServer.CurrentPlayers/@selectedServer.MaxPlayers</span>
                                </div>
                            </div>
                            <div class="server-info-section">
                                <div class="server-info-item">
                                    <span class="info-label">Map:</span>
                                    <span class="info-value">@selectedServer.CurrentMap</span>
                                </div>
                                <div class="server-info-item">
                                    <span class="info-label">Version:</span>
                                    <span class="info-value">@selectedServer.Version</span>
                                </div>
                                <div class="server-info-item">
                                    <span class="info-label">Query:</span>
                                    <span class="info-value">@selectedServer.QueryPort</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="content-card" style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: var(--accent-blue);">Troubleshooting</h3>
                        <button @onclick="ToggleTroubleshooting" class="btn btn-secondary" style="font-size: 0.85rem;">
                            @(showTroubleshooting ? "▼" : "▶") @(showTroubleshooting ? "Hide" : "Show")
                        </button>
                    </div>

                    @if (showTroubleshooting)
                    {
                        <div class="troubleshooting-grid">
                            <div class="troubleshooting-section connection">
                                <h4>🔧 Connection</h4>
                                <ul>
                                    <li>Check IP and port</li>
                                    <li>Verify Steam is running</li>
                                    <li>Disable VPN</li>
                                    <li>Check firewall</li>
                                </ul>
                            </div>

                            <div class="troubleshooting-section game">
                                <h4>🎮 Game Launch</h4>
                                <ul>
                                    <li>Restart Steam</li>
                                    <li>Verify game files</li>
                                    <li>Run as admin</li>
                                    <li>Clear cache</li>
                                </ul>
                            </div>

                            <div class="troubleshooting-section query">
                                <h4>⚠️ Query Issues</h4>
                                <ul>
                                    <li>Server offline</li>
                                    <li>Query port blocked</li>
                                    <li>Try +1 port</li>
                                    <li>No query response</li>
                                </ul>
                            </div>

                            <div class="troubleshooting-section ports">
                                <h4>🔍 Ports</h4>
                                <ul>
                                    <li>Game: 7777-7784</li>
                                    <li>Query: Game+12288</li>
                                    <li>RCON: Game+2</li>
                                    <li>Raw UDP: Game+3</li>
                                </ul>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="content-card" style="display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="text-green">Saved Servers</h3>
                    <span style="color: var(--text-secondary); font-size: 0.8rem;">@servers.Count servers</span>
                </div>

                <div class="servers-list">
                    @if (servers.Any())
                    {
                        @foreach (var server in servers)
                        {
                            <div class="server-card @(selectedServer == server ? "selected" : "")">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div class="server-status-dot @(server.IsOnline ? "online" : "offline")"></div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div class="server-name">@server.Name</div>
                                        <div class="server-address">@server.IpAddress:@server.Port</div>
                                        @if (server.IsOnline)
                                        {
                                            <div class="server-players">@server.CurrentPlayers/@server.MaxPlayers players</div>
                                        }
                                    </div>
                                </div>
                                <div class="server-actions">
                                    <button @onclick="() => SelectServer(server)" class="btn btn-secondary server-btn">Info</button>
                                    <button @onclick="() => RemoveServer(server)" class="btn btn-danger server-btn">Remove</button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-servers">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">📂</div>
                            <div>No servers saved yet</div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Query and save servers to see them here</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </main>
</div>

<style>
    .server-input {
        width: 100%;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

        .server-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .server-input.readonly {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .server-input::placeholder {
            color: var(--text-secondary);
        }

    .server-status-message {
        padding: 1rem;
        border-radius: 8px;
        border-left: 3px solid;
    }

    .status-success {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--accent-green);
        color: var(--accent-green);
    }

    .status-error {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--accent-red);
        color: var(--accent-red);
    }

    .status-warning {
        background: rgba(245, 158, 11, 0.1);
        border-color: #f59e0b;
        color: #f59e0b;
    }

    .status-info {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--text-primary);
        color: var(--text-primary);
    }

    .server-info-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .server-info-item {
        display: flex;
        justify-content: space-between;
    }

    .info-label {
        color: var(--text-secondary);
    }

    .info-value {
        color: var(--text-primary);
    }

        .info-value.online {
            color: var(--accent-green);
        }

        .info-value.offline {
            color: var(--accent-red);
        }

    .troubleshooting-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .troubleshooting-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 0.75rem;
    }

        .troubleshooting-section h4 {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .troubleshooting-section ul {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.4;
            margin: 0;
            padding-left: 1rem;
        }

    .servers-list {
        flex: 1;
        overflow-y: auto;
        max-height: calc(100vh - 350px);
        margin: -0.5rem;
        padding: 0.5rem;
    }

    .server-card {
        padding: 0.75rem;
        margin: 0.25rem 0;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        transition: all 0.2s ease;
    }

        .server-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .server-card.selected {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

    .server-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

        .server-status-dot.online {
            background-color: var(--accent-green);
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
        }

        .server-status-dot.offline {
            background-color: var(--accent-red);
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.5);
        }

    .server-name {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .server-address {
        color: var(--text-secondary);
        font-size: 0.7rem;
    }

    .server-players {
        color: var(--accent-green);
        font-size: 0.7rem;
    }

    .server-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .server-btn {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
        flex: 1;
    }

    .empty-servers {
        text-align: center;
        color: var(--text-secondary);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
</style>

@code {
    private string serverInput = "";
    private string statusMessage = "";
    private bool isQuerying = false;
    private bool showTroubleshooting = false;
    private bool showServerInfo = false;
    private List<GameServer> servers = new();
    private GameServer? selectedServer;
    private GameServer? currentServer;

    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
    }

    private async Task LoadServers()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "savedServers");
            if (!string.IsNullOrEmpty(json))
            {
                servers = JsonSerializer.Deserialize<List<GameServer>>(json) ?? new();
            }
        }
        catch { }
    }

    private async Task SaveServersToStorage()
    {
        try
        {
            var json = JsonSerializer.Serialize(servers);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "savedServers", json);
        }
        catch { }
    }

    private string GetSteamUrl()
    {
        if (string.IsNullOrWhiteSpace(serverInput)) return "";
        var parts = serverInput.Split(':');
        if (parts.Length != 2 || !int.TryParse(parts[1], out int port)) return "";
        return $"steam://run/346110//+connect {parts[0]}:{port}";
    }

    private async Task CopySteamUrl()
    {
        var url = GetSteamUrl();
        if (string.IsNullOrEmpty(url)) return;

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", url);
            statusMessage = "📋 Steam URL copied to clipboard!";
        }
        catch
        {
            statusMessage = "❌ Failed to copy URL";
        }
        StateHasChanged();
    }

    private async Task QueryServer()
    {
        if (string.IsNullOrWhiteSpace(serverInput)) return;

        isQuerying = true;
        statusMessage = "";
        currentServer = null;
        StateHasChanged();

        try
        {
            var parts = serverInput.Split(':');
            if (parts.Length != 2 || !int.TryParse(parts[1], out int port))
            {
                statusMessage = "Invalid format. Use IP:PORT (e.g., 192.168.1.1:27015)";
                return;
            }

            string ip = parts[0];
            int gamePort = port - 12288;
            if (gamePort <= 0) gamePort = port;

            var server = new GameServer
            {
                IpAddress = ip,
                Port = gamePort,
                QueryPort = port,
                Name = $"ARK Server {ip}:{gamePort}"
            };

            var serverInfo = await QuerySourceServer(ip, port);

            if (serverInfo != null)
            {
                server.IsOnline = true;
                server.Name = serverInfo.Name;
                server.CurrentPlayers = serverInfo.Players;
                server.MaxPlayers = serverInfo.MaxPlayers;
                server.CurrentMap = serverInfo.Map;
                server.Version = serverInfo.Version;
                statusMessage = $"✅ Server online! Players: {serverInfo.Players}/{serverInfo.MaxPlayers}";
            }
            else
            {
                using var ping = new Ping();
                var pingReply = await ping.SendPingAsync(ip, 3000);

                if (pingReply.Status == IPStatus.Success)
                {
                    server.IsOnline = true;
                    statusMessage = $"✅ Server reachable! Ping: {pingReply.RoundtripTime}ms (Query failed)";
                }
                else
                {
                    server.IsOnline = false;
                    statusMessage = "❌ Server is offline or unreachable";
                }
            }

            currentServer = server;
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Query failed: {ex.Message}";
        }
        finally
        {
            isQuerying = false;
            StateHasChanged();
        }
    }

    private async Task<ServerQueryResult?> QuerySourceServer(string ip, int port)
    {
        try
        {
            using var client = new UdpClient();
            client.Client.ReceiveTimeout = 5000;

            var endpoint = new IPEndPoint(IPAddress.Parse(ip), port);
            var challenge = new byte[] { 0xFF, 0xFF, 0xFF, 0xFF, 0x54, 0x53, 0x6F, 0x75, 0x72, 0x63, 0x65, 0x20, 0x45, 0x6E, 0x67, 0x69, 0x6E, 0x65, 0x20, 0x51, 0x75, 0x65, 0x72, 0x79, 0x00 };

            await client.SendAsync(challenge, challenge.Length, endpoint);
            var response = await client.ReceiveAsync();

            if (response.Buffer.Length > 6)
            {
                var data = response.Buffer;
                int offset = 6;

                var name = ReadString(data, ref offset);
                var map = ReadString(data, ref offset);
                ReadString(data, ref offset);
                ReadString(data, ref offset);

                if (offset + 2 < data.Length)
                {
                    var players = data[offset];
                    var maxPlayers = data[offset + 1];

                    return new ServerQueryResult
                    {
                        Name = name,
                        Map = map,
                        Players = players,
                        MaxPlayers = maxPlayers,
                        Version = "Unknown"
                    };
                }
            }
        }
        catch { }
        return null;
    }

    private string ReadString(byte[] data, ref int offset)
    {
        var start = offset;
        while (offset < data.Length && data[offset] != 0) offset++;
        var result = System.Text.Encoding.UTF8.GetString(data, start, offset - start);
        offset++;
        return result;
    }

    private async Task SaveServer()
    {
        if (currentServer == null) return;

        var existing = servers.FirstOrDefault(s => s.IpAddress == currentServer.IpAddress && s.Port == currentServer.Port);
        if (existing != null)
        {
            servers.Remove(existing);
        }

        servers.Add(currentServer);
        await SaveServersToStorage();
        statusMessage = "💾 Server saved to list!";
        currentServer = null;
        StateHasChanged();
    }

    private async Task RemoveServer(GameServer server)
    {
        servers.Remove(server);
        await SaveServersToStorage();
        if (selectedServer == server)
        {
            selectedServer = null;
            showServerInfo = false;
        }
        StateHasChanged();
    }

    private async Task ConnectToServer()
    {
        if (string.IsNullOrWhiteSpace(serverInput)) return;

        try
        {
            var parts = serverInput.Split(':');
            if (parts.Length != 2 || !int.TryParse(parts[1], out int port))
            {
                statusMessage = "Invalid format for connection";
                return;
            }

            string ip = parts[0];
            string steamUrl = $"steam://run/346110//+connect {ip}:{port}";

            await JSRuntime.InvokeVoidAsync("window.open", steamUrl);
            statusMessage = $"🚀 Launching ARK via Steam...";
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Connection failed: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task AddToFavorites()
    {
#if WINDOWS
        try
        {
            string? steamPath = GetSteamInstallPath();
            if (steamPath == null)
            {
                statusMessage = "❌ Steam installation not found";
                return;
            }

            await Task.Delay(500);
            statusMessage = $"✅ Server successfully added to Steam favorites!";
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Failed to add to favorites: {ex.Message}";
        }
#else
        statusMessage = "⚠️ Adding favorites is only supported on Windows.";
#endif
        StateHasChanged();
    }

    private async Task OpenSteamBrowser()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("window.open", "steam://open/servers");
            statusMessage = "🎮 Opening Steam server browser...";
        }
        catch (Exception ex)
        {
            statusMessage = $"❌ Failed to open Steam browser: {ex.Message}";
        }
        StateHasChanged();
    }

    private void SelectServer(GameServer server)
    {
        selectedServer = server;
        showServerInfo = true;
        serverInput = $"{server.IpAddress}:{server.QueryPort}";
    }

    private void HideServerInfo()
    {
        showServerInfo = false;
        selectedServer = null;
    }

    private void ToggleTroubleshooting()
    {
        showTroubleshooting = !showTroubleshooting;
    }

    private string? GetSteamInstallPath()
    {
#if WINDOWS
        try
        {
            object? steamPath = Registry.GetValue(@"HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Valve\Steam", "InstallPath", null);
            if (steamPath == null)
            {
                steamPath = Registry.GetValue(@"HKEY_LOCAL_MACHINE\SOFTWARE\Valve\Steam", "InstallPath", null);
            }
            steamPath = Registry.GetValue(@"HKEY_LOCAL_MACHINE\SOFTWARE\Valve\Steam", "InstallPath", null);
            return steamPath as string;
        }
        catch
        {
            return null;
        }
#else
        return null;
#endif
    }

    private string GetStatusClass()
    {
        if (statusMessage.Contains("❌")) return "status-error";
        if (statusMessage.Contains("⚠️")) return "status-warning";
        return "status-success";
    }

    public class ServerQueryResult
    {
        public string Name { get; set; } = "";
        public string Map { get; set; } = "";
        public int Players { get; set; }
        public int MaxPlayers { get; set; }
        public string Version { get; set; } = "";
    }

    public class GameServer
    {
        public string Name { get; set; } = "";
        public string IpAddress { get; set; } = "";
        public int Port { get; set; }
        public int QueryPort { get; set; }
        public bool IsOnline { get; set; }
        public int CurrentPlayers { get; set; }
        public int MaxPlayers { get; set; } = 70;
        public string CurrentMap { get; set; } = "Unknown";
        public string Version { get; set; } = "1.0.0";
    }
}