@page "/game"
@using System.Diagnostics
@using System.Runtime.InteropServices
@using Microsoft.JSInterop
@using RazorReaper.Components.Shared

@inject IJSRuntime JSRuntime

<div class="app-container">
    <RazorReaper.Components.Shared.SharedNavbar />

    <main class="main-content">
        <header class="page-header">
            <h1 class="page-title">Game Management</h1>
            <p class="page-subtitle">Control & Monitor ARK: Survival Evolved</p>
        </header>

        <div class="content-card">
            <div class="game-status">
                <div class="status-indicator">
                    <div class="status-dot @(isGameRunning ? "online" : "offline")"></div>
                    <div class="status-info">
                        <h3>ARK: Survival Evolved</h3>
                        <span class="status-text">@(isGameRunning ? "Running" : "Not Running")</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <div class="game-actions">
                <button class="game-btn primary" @onclick="LaunchGame" disabled="@isGameRunning">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    Launch Game
                </button>

                <button class="game-btn danger" @onclick="CloseGame" disabled="@(!isGameRunning)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <line x1="9" y1="9" x2="15" y2="15" />
                        <line x1="15" y1="9" x2="9" y2="15" />
                    </svg>
                    Close Game
                </button>

                <button class="game-btn success" @onclick="ExecuteReconnect" disabled="@(!isGameRunning)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.35 0 4.48.9 6.07 2.38" />
                        <polyline points="21 4 21 12 13 12" />
                    </svg>
                    Reconnect
                </button>

                <button class="game-btn warning" @onclick="ExecuteDisconnect" disabled="@(!isGameRunning)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18.36 6.64a9 9 0 1 1-12.73 0" />
                        <line x1="12" y1="2" x2="12" y2="12" />
                    </svg>
                    Disconnect
                </button>
            </div>
        </div>

    </main>
</div>

@code {
    // Windows API imports
    private const int SW_RESTORE = 9;
    private const uint KEYEVENTF_KEYUP = 0x0002;
    private const uint VK_TAB = 0x09;
    private const uint VK_RETURN = 0x0D;

    [DllImport("user32.dll")]
    private static extern bool SetForegroundWindow(IntPtr hWnd);
    [DllImport("user32.dll")]
    private static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
    [DllImport("user32.dll")]
    private static extern void keybd_event(byte bVk, byte bScan, uint dwFlags, UIntPtr dwExtraInfo);
    [DllImport("user32.dll")]
    private static extern IntPtr GetForegroundWindow();

    // Component state
    private bool isGameRunning = false;
    private Timer? statusTimer;

    protected override void OnInitialized()
    {
        CheckGameStatus();
        // Check game status every 5 seconds
        statusTimer = new Timer(async _ =>
        {
            CheckGameStatus();
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(5));
    }

    private void CheckGameStatus()
    {
        Process[] processes = Process.GetProcessesByName("ShooterGame");
        isGameRunning = processes.Length > 0;
    }

    private async Task ExecuteReconnect()
    {
        await ExecuteGameCommand("reconnect");
    }

    private async Task ExecuteDisconnect()
    {
        await ExecuteGameCommand("disconnect");
    }

    private async Task ExecuteGameCommand(string command)
    {
        try
        {
            Process[] processes = Process.GetProcessesByName("ShooterGame");
            if (processes.Length > 0)
            {
                IntPtr gameWindowHandle = processes[0].MainWindowHandle;

                // Bring window to foreground
                ShowWindow(gameWindowHandle, SW_RESTORE);
                await Task.Delay(100);
                SetForegroundWindow(gameWindowHandle);
                await Task.Delay(500);

                // Press TAB to open console
                keybd_event((byte)VK_TAB, 0, 0, UIntPtr.Zero);
                await Task.Delay(50);
                keybd_event((byte)VK_TAB, 0, KEYEVENTF_KEYUP, UIntPtr.Zero);
                await Task.Delay(300);

                // Send each character of the command
                foreach (char c in command.ToLower())
                {
                    SendChar(c);
                    await Task.Delay(50);
                }

                await Task.Delay(200);

                // Press Enter
                keybd_event((byte)VK_RETURN, 0, 0, UIntPtr.Zero);
                await Task.Delay(50);
                keybd_event((byte)VK_RETURN, 0, KEYEVENTF_KEYUP, UIntPtr.Zero);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "ARK: Survival Evolved is not running!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }

        StateHasChanged();
    }

    private void SendChar(char c)
    {
        byte vk = (byte)char.ToUpper(c);
        keybd_event(vk, 0, 0, UIntPtr.Zero);
        keybd_event(vk, 0, KEYEVENTF_KEYUP, UIntPtr.Zero);
    }

    private async Task LaunchGame()
    {
        try
        {
            Process.Start(new ProcessStartInfo
            {
                FileName = "steam://rungameid/346110",
                UseShellExecute = true
            });

            await Task.Delay(5000);
            CheckGameStatus();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error launching game: {ex.Message}");
        }

        StateHasChanged();
    }

    private async Task CloseGame()
    {
        try
        {
            Process[] processes = Process.GetProcessesByName("ShooterGame");
            foreach (var process in processes)
            {
                process.Kill();
                process.WaitForExit(5000);
            }

            CheckGameStatus();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error closing game: {ex.Message}");
        }

        StateHasChanged();
    }

    public void Dispose()
    {
        statusTimer?.Dispose();
    }
}